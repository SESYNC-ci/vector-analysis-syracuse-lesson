---
editor_options: 
  chunk_output_type: console
---

## Spatial Join

The data about lead contamination in soils is at points; the census information
is for polygons. Combine the information from these tables by determining which
polygon contains each point.

```{r, title = '{{ site.handouts[0] }}' }
plot(census_tracts['POP2000'],
  pal = cm.colors)
plot(sf$st_geometry(lead),
  pch = '.', add = TRUE)
```

===

In the previous section, we performed a table join using a non-spatial
data type. More specifically, we performed an equality join: records were merged
wherever the join variable in the "left table" equalled the variable in the
"right table". Spatial joins operate on the "geometry" columns and require
expanding beyond equality based matches. Several different kinds of "intersections" can be specified that denote a successful match.
{:.notes}

![]({{ site.baseurl }}/images/TopologicSpatialRelarions2.png){:width="70%"}  
*[Image][geometry-predicates] by Kraus / [CC BY]*
{:.captioned}

===

Before doing any spatial join, it is essential that both tables share a common
CRS.

```{r, results = 'hide'}
sf$st_crs(lead)
sf$st_crs(census_tracts)
```

===

The `st_join` function performs a left join using the geometries of the two
simple feature collections.

```{r}
sf$st_join(lead, census_tracts)
```

===

- Only the "left" geometry is preserved in the output
- Matching defaults to `st_intersects` but permits any predicate function

```{r}
sf$st_join(lead, census_tracts,
  join = st_contains)
```

===

The population data is at the coarser scale, so the lead ought to be averaged
within a census tract. Once each lead measurement is joined to "TRACT", the
spatial data can by dropped.

```{r, title = '{{ site.handouts[0] }}' }
lead_tracts <- lead %>%
    sf$st_join(census_tracts) %>%
    sf$st_set_geometry(NULL)
```

===

Two more steps to group the data by "TRACT" and average the lead concentrations within each "TRACT".

```{r, title = '{{ site.handouts[0] }}' }
lead_tracts <- lead %>%
    sf$st_join(census_tracts) %>%
    sf$st_set_geometry(NULL) %>%
    group_by(TRACT) %>%
    summarise(avg_ppm = mean(ppm))
```

===

To visualize the average lead concentration from soil samples within each cencus tract, merge the data frame to the `sf` object on "TRACT".

```{r, title = '{{ site.handouts[0] }}', message = FALSE}
census_lead_tracts <- census_tracts %>%
  inner_join(lead_tracts)
plot(census_lead_tracts['avg_ppm'],
  pal = heat.colors)
```

===

A problem with this approach to aggregation is that it ignores autocorrelation. Points close to eachother tend to have similar values and shouldn't be given equal weight in averages within a polygon.

===

Take a closer look at tract 5800 (in row 52), and notice that several low values are nearly
stacked on top of eachother.

```{r, eval = FALSE}
m <- import('mapview')
m$mapview(sf$st_geometry(census_tracts)) +
  m$mapview(lead['ppm'])
```

[geometry-predicates]: https://en.wikipedia.org/wiki/DE-9IM
[CC BY]: https://creativecommons.org/licenses/by-sa/3.0/
